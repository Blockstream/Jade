#
# Test firmware build stage
#
# Used to build test firmware images:
# - _ci images that auto-click buttons to allow running test_jade on.
# - qemu images for running the tests on qemu.
#
# These artifacts aren't released so retain them only for 2 days.
#
.build_test_template:
  extends: .build_template
  stage: build_test
  artifacts:
    expire_in: 2 days
  before_script:
    # Create CI config from the default developer device config
    - echo $CI_JOB_NAME | sed "s/^${CI_JOB_STAGE}//" | sed "s/_ci$//" >device_name
    - cp configs/sdkconfig$(cat device_name).defaults sdkconfig.defaults
    - echo "CONFIG_DEBUG_UNATTENDED_CI=y" >>sdkconfig.defaults
    - echo "CONFIG_HEAP_POISONING_COMPREHENSIVE=y" >>sdkconfig.defaults
    - echo "CONFIG_LOG_DEFAULT_LEVEL_NONE=y" >>sdkconfig.defaults

build_test_qemu:
  extends: .build_test_template

build_test_qemu_psram:
  extends: .build_test_template

build_test_qemu_psram_unamalgamated:
  extends: .build_test_template

build_test_jade_ci:
  extends: .build_test_template

build_test_jade_v1_1_ci:
  extends: .build_test_template

build_test_jade_v2_ci:
  extends: .build_test_template

build_test_jade_noradio_ci:
  extends: .build_test_template

build_test_jade_v1_1_noradio_ci:
  extends: .build_test_template

build_test_jade_v2_noradio_ci:
  extends: .build_test_template
