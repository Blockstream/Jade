#
# Flash (and test) stage
#

#
# QEMU
#
.flash_qemu_template:
  stage: flash
  tags: [ ga ]
  variables:
    # Skip submodule sync to make flashing/testing faster
    GIT_SUBMODULE_STRATEGY: none
  script:
    - mv $(echo $CI_JOB_NAME | sed "s/^${CI_JOB_STAGE}/build_test/") build
    - ./main/qemu/make-flash-img.sh
    - ./main/qemu/qemu_ci_flash.sh

flash_qemu:
  extends: .flash_qemu_template
  needs: [ test_libjade, build_test_qemu ]

flash_qemu_psram:
  extends: .flash_qemu_template
  needs: [ test_libjade, build_test_qemu_psram ]

flash_qemu_psram_unamalgamated:
  extends: .flash_qemu_template
  needs: [ test_libjade, build_test_qemu_psram_unamalgamated ]

#
# CI builds
#

# Jade v1.0
.flash_jade_template:
  stage: flash
  tags: [ jadedev_flasher ]
  variables:
    GIT_SUBMODULE_STRATEGY: none
  # Note docker compose expects JADESERIALPORT to be set for the runner
  script:
    - mv $(echo $CI_JOB_NAME | sed "s/^${CI_JOB_STAGE}/build_test/") build
    - cp -a build/sdkconfig ./
    - git submodule update --init --depth 1 pinserver
    - docker-compose run --remove-orphans --rm dev bash -c "JADESERIALPORT=$JADESERIALPORT ./ci_flash.sh esp32 --skipble"
  # FIXME: Fix v1.0 flashing (devices sometimes don't come back from reboot)
  allow_failure: true

flash_jade_ci:
  extends: .flash_jade_template
  needs: [ test_libjade, build_test_jade_ci ]

flash_jade_noradio_ci:
  extends: .flash_jade_template
  needs:
    - job: build_test_jade_noradio_ci
      artifacts: true
    - job: flash_jade_ci
      artifacts: false

flash_jade_ota_delta_ci:
  extends: .flash_jade_template
  needs:
    - job: build_test_jade_ci
      artifacts: true
    - job: build_test_jade_noradio_ci
      artifacts: true
    - job: flash_jade_noradio_ci
      artifacts: false
  script:
    - mv build_test_jade_ci build
    - mv build_test_jade_noradio_ci build_noradio
    - git submodule update --init --depth 1 pinserver
    - docker-compose run --remove-orphans --rm dev bash -c "JADESERIALPORT=$JADESERIALPORT ./ota_delta_ci.sh esp32 --skipble"

# Jade v1.1
.flash_jade_v1_1_template:
  extends: .flash_jade_template
  tags: [ jade1.1dev_flasher ]
  allow_failure: false

flash_jade_v1_1_ci:
  extends: .flash_jade_v1_1_template
  needs: [ test_libjade, build_test_jade_v1_1_ci ]

flash_jade_v1_1_noradio_ci:
  extends: .flash_jade_v1_1_template
  needs:
    - job: build_test_jade_v1_1_noradio_ci
      artifacts: true
    - job: flash_jade_v1_1_ci
      artifacts: false

flash_jade_ota_delta_v1_1_ci:
  extends: .flash_jade_v1_1_template
  needs:
    - job: build_test_jade_v1_1_ci
      artifacts: true
    - job: build_test_jade_v1_1_noradio_ci
      artifacts: true
    - job: flash_jade_v1_1_noradio_ci
      artifacts: false
  script:
    - mv build_test_jade_v1_1_ci build
    - mv build_test_jade_v1_1_noradio_ci build_noradio
    - git submodule update --init --depth 1 pinserver
    - docker-compose run --remove-orphans --rm dev bash -c "JADESERIALPORT=$JADESERIALPORT ./ota_delta_ci.sh esp32 --skipble"

# Jade v2.0
.flash_jade_v2_template:
  stage: flash
  tags: [ jade2.0dev_flasher ]
  variables:
    GIT_SUBMODULE_STRATEGY: none
  # Note docker compose expects JADESERIALPORT to be set for the runner
  script:
    - mv $(echo $CI_JOB_NAME | sed "s/^${CI_JOB_STAGE}/build_test/") build
    - cp -a build/sdkconfig ./
    - git submodule update --init --depth 1 pinserver
    - docker-compose run --remove-orphans --rm dev bash -c "JADESERIALPORT=$JADESERIALPORT ./ci_flash.sh esp32s3 --skipble"

flash_jade_v2_ci:
  extends: .flash_jade_v2_template
  needs: [ test_libjade, build_test_jade_v2_ci ]

flash_jade_v2_noradio_ci:
  extends: .flash_jade_v2_template
  needs:
    - job: build_test_jade_v2_noradio_ci
      artifacts: true
    - job: flash_jade_v2_ci
      artifacts: false

flash_jade_ota_delta_v2_ci:
  extends: .flash_jade_v2_template
  needs:
    - job: build_test_jade_v2_ci
      artifacts: true
    - job: build_test_jade_v2_noradio_ci
      artifacts: true
    - job: flash_jade_v2_noradio_ci
      artifacts: false
  script:
    - mv build_test_jade_v2_ci build
    - mv build_test_jade_v2_noradio_ci build_noradio
    - git submodule update --init --depth 1 pinserver
    - docker-compose run --remove-orphans --rm dev bash -c "JADESERIALPORT=$JADESERIALPORT ./ota_delta_ci.sh esp32s3 --skipble"

# Jade v2.0c
.flash_jade_v2c_template:
  stage: flash
  tags: [ jade2.0cdev_flasher ]
  variables:
    GIT_SUBMODULE_STRATEGY: none
  # Note docker compose expects JADESERIALPORT to be set for the runner
  script:
    - mv $(echo $CI_JOB_NAME | sed "s/^${CI_JOB_STAGE}/build_test/") build
    - cp -a build/sdkconfig ./
    - git submodule update --init --depth 1 pinserver
    - docker-compose run --remove-orphans --rm dev bash -c "JADESERIALPORT=$JADESERIALPORT ./ci_flash.sh esp32s3 --skipble"

flash_jade_v2c_ci:
  extends: .flash_jade_v2c_template
  needs: [ test_libjade, build_test_jade_v2c_ci ]

flash_jade_v2c_noradio_ci:
  extends: .flash_jade_v2c_template
  needs:
    - job: build_test_jade_v2c_noradio_ci
      artifacts: true
    - job: flash_jade_v2c_ci
      artifacts: false

flash_jade_ota_delta_v2c_ci:
  extends: .flash_jade_v2c_template
  needs:
    - job: build_test_jade_v2c_ci
      artifacts: true
    - job: build_test_jade_v2c_noradio_ci
      artifacts: true
    - job: flash_jade_v2c_noradio_ci
      artifacts: false
  script:
    - mv build_test_jade_v2c_ci build
    - mv build_test_jade_v2c_noradio_ci build_noradio
    - git submodule update --init --depth 1 pinserver
    - docker-compose run --remove-orphans --rm dev bash -c "JADESERIALPORT=$JADESERIALPORT ./ota_delta_ci.sh esp32s3 --skipble"
