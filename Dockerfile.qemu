FROM blockstream/jade_builder@sha256:af81775ea2754bdb9494b644327233ddd19403acbb94232ca2824785e13e89fc

ARG QEMU_CONFIG_ARGS="--dev --ci --psram"
ARG QEMU_GDB=""

WORKDIR /jade

COPY . .
RUN ./tools/switch_to.sh qemu ${QEMU_CONFIG_ARGS}
RUN cd /opt/esp/idf && . ./export.sh && cd /jade && idf.py all && ./tools/fwprep.py build/jade.bin build
RUN ./main/qemu/make-flash-img.sh
CMD [ "/jade/main/qemu/qemu_run.sh", "$QEMU_GDB" ]
